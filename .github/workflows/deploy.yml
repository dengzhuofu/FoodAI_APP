name: Deploy Backend to Tencent Cloud

on:
  push:
    branches:
      - main  # 如果你的分支叫 master，请改这里
    paths:
      - 'backend/**'  # 只在 backend 文件夹有改动时触发

      - '.github/workflows/deploy.yml' # 修改部署脚本也触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file from Secrets
        run: |
          cd backend
          touch .env
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "ALGORITHM=${{ secrets.ALGORITHM }}" >> .env
          echo "ACCESS_TOKEN_EXPIRE_MINUTES=${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}" >> .env
          echo "SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY }}" >> .env
          echo "SILICONFLOW_BASE_URL=${{ secrets.SILICONFLOW_BASE_URL }}" >> .env
          echo "TENCENT_COS_SECRET_ID=${{ secrets.TENCENT_COS_SECRET_ID }}" >> .env
          echo "TENCENT_COS_SECRET_KEY=${{ secrets.TENCENT_COS_SECRET_KEY }}" >> .env
          echo "TENCENT_COS_REGION=${{ secrets.TENCENT_COS_REGION }}" >> .env
          echo "TENCENT_COS_BUCKET=${{ secrets.TENCENT_COS_BUCKET }}" >> .env
          echo "AMAP_API_KEY=${{ secrets.AMAP_API_KEY }}" >> .env

      - name: Compress backend files
        run: |
          tar -czf release.tar.gz -C backend --exclude='./static/uploads' --exclude='./static/uploads/**' .
          ls -lh release.tar.gz

      - name: Probe SSH connectivity
        run: |
          echo "Runner public IP: $(curl -s https://api.ipify.org)"
          echo "Testing TCP connectivity to ${{ secrets.SERVER_IP }}:22"
          timeout 10 bash -lc "cat < /dev/null > /dev/tcp/${{ secrets.SERVER_IP }}/22" && echo "Port 22 reachable" || (echo "Port 22 NOT reachable" && exit 1)

      - name: Copy files to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          # 如果使用密钥登录，请把 password 换成 key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "release.tar.gz"
          target: "/tmp"
          debug: true
          timeout: 10m
          command_timeout: 30m

      - name: Execute remote commands via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          # key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 确保目标目录存在
            sudo mkdir -p /var/www/foodai
            
            # 解压文件到目标目录 (使用 sudo 避免权限问题)
            sudo tar -xzf /tmp/release.tar.gz -C /var/www/foodai
            
            # 清理临时文件
            rm /tmp/release.tar.gz
            
            cd /var/www/foodai
            
            # 确保 venv 存在
            if [ ! -d "venv" ]; then
              sudo apt-get install -y python3-venv || true
              python3 -m venv venv
            fi
            
            # 激活虚拟环境并安装依赖
            ./venv/bin/pip install -r requirements.txt
            
            # 确保日志目录权限 (如果需要)
            # sudo chown -R www-data:www-data /var/www/foodai
            
            # 重启服务
            sudo systemctl restart foodai

            sudo systemctl is-active foodai
            sudo systemctl status foodai --no-pager -l
            sudo journalctl -u foodai -n 200 --no-pager
            curl -sS -D- http://127.0.0.1:8000/ -o /dev/null
            curl -sS -D- http://127.0.0.1:8000/api/v1/health -o /dev/null
            
            # 检查状态
            sudo systemctl status foodai | grep Active
